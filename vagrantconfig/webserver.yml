---

- hosts: webservers
  user: vagrant
  sudo: True

  tasks:
    - name: update apt
      action: command /usr/bin/apt-get update

    #-------------
    # Dev tools
    #-------------

    - name: install developer tools
      action: apt pkg=$item state=present
      with_items:
        - vim
        - tmux

    #-------------
    # Python tools
    #-------------

    - name: install python-software-properties
      action: apt pkg=$item state=present
      with_items:
        - python-software-properties
        - build-essential
        - python-dev
        - python-setuptools

    - name: install pip
      action: easy_install name=pip

    - name: update easy_install packages
      action: command /usr/bin/easy_install -U distribute

    #-------------
    # MongoDB
    #-------------

    # I tried installing MongoDB from 10gen's repos. Unfortunately, there's a
    # bug with apt_repository where it includes deb-source automatically. Since
    # 10gen doesn't have a deb-source, installing throws an error.
    #
    # - name: add 10gen mongodb repository key
    #   action: command /usr/bin/apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
    #
    # - name: add 10gen mongodb repository
    #   action: apt_repository repo='deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' state=present
    #
    # - name: install mongodb from 10gen repository
    #   action: apt pkg=mongodb-10gen state=present

    - name: install mongodb packages
      action: apt pkg=$item state=present
      with_items:
        - mongodb
        - python-pymongo
        - mongodb-clients

    #-------------
    # VCS
    #-------------

    - name: install mercurial
      action: apt pkg=mercurial state=present

    - name: install git
      action: apt pkg=git state=present

    #-------------
    # Ansible
    #-------------

    - name: download ansible
      action: command /usr/bin/git clone https://github.com/ansible/ansible.git chdir='/tmp' creates='/tmp/ansible'

    - name: install ansible
      action: command make install chdir='/tmp/ansible'

    #-------------
    # Django
    #-------------

    - name: install libjpeg8
      action: apt pkg=libjpeg8-dev state=present

    - name: install django pip packages
      action: pip name=$item state=present
      with_items:
        - hg+https://bitbucket.org/wkornewald/django-nonrel
        - hg+https://bitbucket.org/wkornewald/djangotoolbox
        - git+https://github.com/django-nonrel/mongodb-engine
        - jinja2
        - paramiko
        - PyYAML
        - pillow
        - djangorestframework
        - django-ember

    #-------------
    # ROS
    #-------------

    # Tried adding key with command:
    # wget http://packages.ros.org/ros.key -O - | sudo apt-key add -
    # But got an error. May be worth sending in a patch to Ansible's
    # apt_repository module.
    - name: download ros repository key
      action: get_url url=http://packages.ros.org/ros.key dest=/tmp/ros.key

    - name: install ros repository key
      action: command /usr/bin/apt-key add /tmp/ros.key

    - name: add ros fuerte repository
      action: apt_repository repo='deb http://packages.ros.org/ros/ubuntu precise main' state=present

    - name: install ros
      action: apt pkg=ros-fuerte-desktop-full state=present

    - name: install third-party ros packages
      action: apt pkg=$item state=present
      with_items:
        - ros-fuerte-rosbridge-suite

    #-------------
    # Application
    #-------------

    - name: set up local_settings.py for vagrant
      action: command /bin/cp local_settings.vagrant.py local_settings.py chdir='~/layer'

    # These python commands do not return.
    # - name: sync up database
    #   action: command /usr/bin/python2.7 ./manage.py syncdb chdir='~/layer'

    # - name: run django
    #   action: command /usr/bin/python2.7./manage.py runserver 0.0.0.0:8000 chdir='~/layer'

